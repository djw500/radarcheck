{% extends "base.html" %}

{% block title %}{{ location_name }} - HRRR Forecast{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block header_content %}
<p>Compare multiple forecast runs to assess confidence</p>
{% endblock %}

{% block content %}
<h2>{{ location_name }}</h2>

<div class="run-selector">
    <strong>Select Model:</strong>
    <select id="modelSelect">
        {% for model_key, model in models.items() %}
        <option value="{{ model_key }}" {% if model_key == model_id %}selected{% endif %}>
            {{ model.name }}
        </option>
        {% endfor %}
    </select>

    <strong>Select Variable:</strong>
    <select id="variableSelect">
        {% for category_id, category in variables.categories.items() %}
        <optgroup label="{{ category.name }}">
            {% for var_id in category.variables %}
            <option value="{{ var_id }}" {% if var_id == variable_id %}selected{% endif %}>
                {{ variables.variables[var_id].display_name }}
            </option>
            {% endfor %}
        </optgroup>
        {% endfor %}
    </select>
</div>

<div class="run-selector">
    <strong>Select Model Run:</strong>
    {% for run in runs %}
    <a href="/location/{{ location_id }}?run={{ run.run_id }}&model={{ model_id }}&variable={{ variable_id }}" 
       {% if run.run_id == run_id %}class="active"{% endif %}>
       {{ run.init_time }}
    </a>
    {% endfor %}
</div>

<div class="view-selector">
    <button id="singleViewBtn" class="active">Single Run View</button>
    <button id="timelineViewBtn">Timeline View</button>
    <button id="spaghettiViewBtn">Spaghetti Plot</button>
</div>

<div id="singleView" class="view active">
    <p>Model initialized: {{ init_time }}</p>
    <div class="controls">
        <button id="playButton">Play</button>
        <input type="range" id="timeSlider" min="1" max="{{ models[model_id].max_forecast_hours }}" value="1">
        <span id="timeDisplay">Hour +1</span>
        <label class="opacity-control">
            Opacity
            <input type="range" id="opacitySlider" min="0" max="100" value="70">
        </label>
    </div>
    <div class="map-wrapper">
        <div id="weatherMap" class="weather-map"></div>
        <img id="forecastImage" src="/frame/{{ location_id }}/{{ model_id }}/{{ run_id }}/{{ variable_id }}/1" alt="Forecast Plot" class="fallback-image">
        <div id="loading" class="loading">Loading...</div>
    </div>
    <noscript>
        <img id="forecastImage" src="/frame/{{ location_id }}/{{ model_id }}/{{ run_id }}/{{ variable_id }}/1" alt="Forecast Plot" style="width: 100%; height: auto;">
    </noscript>
</div>

<div id="timelineView" class="view">
    <h3>Forecast Timeline</h3>
    <p>Compare how forecasts have evolved across model runs</p>
    
    <div class="timeline-container">
        <div class="timeline">
            <div class="timeline-header">
                <div class="timeline-header-spacer"></div>
                <div class="timeline-cells" id="timelineHeader">
                    <!-- Time headers will be inserted here by JavaScript -->
                </div>
            </div>
            <!-- Timeline rows will be inserted here by JavaScript -->
        </div>
    </div>
    
    <div style="margin-top: 20px;">
        <h4>Selected Forecast</h4>
        <div id="selectedForecast" style="text-align: center; font-style: italic;">
            Select a cell in the timeline to view the forecast
        </div>
        <div style="position: relative; margin-top: 10px;">
            <img id="timelineImage" src="" alt="Selected Forecast" style="width: 100%; height: auto; display: none;">
        </div>
    </div>
</div>

<div id="spaghettiView" class="view">
    <h3>Spaghetti Plot</h3>
    <p>Compare precipitation forecasts across different model runs</p>
    <div id="spaghettiControls" class="spaghetti-controls"></div>
    <div class="spaghetti-container">
        <canvas id="spaghettiChart"></canvas>
    </div>
    <div class="spaghetti-stats" id="spaghettiStats"></div>
    <div style="margin-top: 10px; text-align: center; font-style: italic;">
        Note: This is a simplified visualization. Each line represents a different model run.
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get API key from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const apiKey = urlParams.get('api_key') || '';
    const apiKeyParam = apiKey ? `?api_key=${apiKey}` : '';
    
    // Pass data from Flask to JavaScript
    const locationId = "{{ location_id }}";
    const runId = "{{ run_id }}";
    const modelId = "{{ model_id }}";
    const variableId = "{{ variable_id }}";
    const maxForecastHours = {{ models[model_id].max_forecast_hours }};
    const timelineData = {{ runs|tojson }};
    const validTimes = {{ all_valid_times|tojson }};
    const mapCenter = {
        lat: {{ map_center_lat }},
        lon: {{ map_center_lon }},
        zoom: {{ map_zoom }}
    };
</script>
<script src="{{ url_for('static', filename='js/preferences.js') }}"></script>
<script src="{{ url_for('static', filename='js/interactiveMap.js') }}"></script>
<script src="{{ url_for('static', filename='js/viewSwitching.js') }}"></script>
<script src="{{ url_for('static', filename='js/singleRunView.js') }}"></script>
<script src="{{ url_for('static', filename='js/timelineView.js') }}"></script>
<script src="{{ url_for('static', filename='js/spaghettiPlot.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
